<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <!--  <link rel="stylesheet" href="http://pixel.uji.es/teaching/leaflet/markercluster/dist/MarkerCluster.css" /> -->
  <link rel="stylesheet" href="http://pixel.uji.es/teaching/leaflet/markercluster/dist/MarkerCluster.Default.css" />
  <script src="http://pixel.uji.es/teaching/leaflet/markercluster/dist/leaflet.markercluster-src.js"></script>
  <script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <!--  Google Chart  library-->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  


  <style>
    body {
      padding: 0;
      margin: 0;
    }

    html,
    body,
    #map {
	position: relative;
      height: 100%;
      padding: 0;
      margin: 0;
    }
	
	#side_popup {
	position: relative;
      height: 100%;
	  width: 400px;
	  z-index: 2;
	  float:right;
    }
	
	#chart_div {
	  position: relative;
      height: 300px;
	  width: 400px;
	  z-index: 2;
	  float:left;
    }
  </style>

</head>

<body>
	<div id="side_popup">
		
		<div id="CheckboxDIV" >
			<div>
				<input type="checkbox" id="Temp" name="Temperature" value="Temp">
				<label for="subscribeNews">Temperature</label>
				
				<input type="checkbox" id="Humid" name="Relative Humidity" value="Humi">
				<label for="subscribeNews">Relative Humidity</label>
				
			</div>
			<div>
				<button onclick="drawChart(1)">OK</button>
			</div>
			ID number: <div id="show_id" style="background-color:black;color:white;">ID Value</div>
		</div>
		<div id="chart_div"></div>
	</div>
	
  <div id="map"></div>
  <script>
    //geolocation
    function sensor() {

		var map = new L.Map('map');
		
		/*
		var myCenter = new L.LatLng( 51.9, 7.6);
		var map = new L.Map('map', {
		  center: myCenter,
		  zoom: 10
		}); */

		  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,' +
			  '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			  'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			id: 'mapbox.streets'
		  }).addTo(map);
		
		var url = 'http://localhost:8080/markers_project.geojson';
		// load GeoJSON from an external file 
		$.getJSON(url,function(data){ 
			// add GeoJSON layer to the map once the file is loaded 
			rodents =   L.geoJson(data,{
			  pointToLayer: function(feature,latlng){
				var marker = L.marker(latlng);
				//marker.bindPopup(feature.properties.id + '<br/>' + feature.properties.geoid);
				return marker;
			  },
			  onEachFeature: function (feature, layer) {
				layer.on('click', function (e) {
					console.log(feature.properties.id);
					document.getElementById("show_id").innerHTML = feature.properties.id;
				});

			  }
			});
			
			var clusters = L.markerClusterGroup();
			clusters.addLayer(rodents);
			map.addLayer(clusters); 

			map.fitBounds(rodents.getBounds());

		});

		
    }
    sensor();

//====================== FT PART ======================//
var script = document.createElement('script');
var url = ['https://www.googleapis.com/fusiontables/v2/query?'];
url.push('sql=');
var query = "SELECT * FROM 1Jtg_LywbCaFVZ6_LDaUZfytZDLB2DGEWxR6O-9AV  WHERE 'ID' IN ('1') order By 'Time(s)' ASC "; // Opposite LIKE '1' 
var encodedQuery = encodeURIComponent(query);
url.push(encodedQuery);
url.push('&callback=GetDataFT'); //Calls the function after receiving data from Fusion Table
url.push('&key=AIzaSyCoC9A3WgFneccRufbysInygnWrhCie-T0');
script.src = url.join('');
var body = document.getElementsByTagName('body')[0];
body.appendChild(script);
		
		
var PointsToPlot = [];
function GetDataFT(data){
	//debug
	console.log( data);
	var rows = data['rows'];

	PointsToPlot = [];
	

	for (var i in rows) {
		// Hold X and Y
		var chartValue = [];

		var Temperature = parseFloat(rows[i][0]);
		var Relat_Humid = parseFloat(rows[i][1]);
		var Time = parseFloat(rows[i][6]);

		chartValue.push(Time);
		chartValue.push(Temperature);
		chartValue.push(Relat_Humid);
		PointsToPlot.push(chartValue);

	}
	console.log( PointsToPlot );
}

google.charts.load('current', {packages: ['corechart', 'line']});
google.charts.setOnLoadCallback(drawChart);


function drawChart(x) {
	if (x != 1){		
		//====================== CHART PART ======================//
		var data = new google.visualization.DataTable();
		data.addColumn('number', 'X');
		data.addColumn('number', 'Temperature');
		data.addColumn('number', 'Relative Humidity');

		data.addRows(PointsToPlot)

		var options = {
			//title: 'Company Performance',
			//legend: { position: 'bottom' },
			curveType: 'function',
			hAxis: {
				title: 'Time',
				logScale: false
			},
			/*
			vAxis: {
			  title: 'Popularity',
			  logScale: false
			},
			*/
			explorer: {
				actions: ['dragToZoom', 'rightClickToReset'],
				axis: 'horizontal',
				keepInBounds: true,
				maxZoomIn: 4.0},
			colors: ['#a52714', '#097138']
		};

		var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
		chart.draw(data, options);
	}else{
		//====================== FT PART ======================//
		var script = document.createElement('script');
		var url = ['https://www.googleapis.com/fusiontables/v2/query?'];
		url.push('sql=');
		var query = "SELECT * FROM 1Jtg_LywbCaFVZ6_LDaUZfytZDLB2DGEWxR6O-9AV  WHERE 'ID' LIKE '1' order By 'Time(s)' ASC ";
		var encodedQuery = encodeURIComponent(query);
		url.push(encodedQuery);
		url.push('&callback=GetDataFT'); //Calls the function after receiving data from Fusion Table
		url.push('&key=AIzaSyCoC9A3WgFneccRufbysInygnWrhCie-T0');
		script.src = url.join('');
		var body = document.getElementsByTagName('body')[0];
		body.appendChild(script);
		
		//====================== CHART PART ======================//
		var data = new google.visualization.DataTable();
		data.addColumn('number', 'X');
		data.addColumn('number', 'Temperature');
		data.addColumn('number', 'Relative Humidity');

		data.addRows(PointsToPlot)

		var options = {
			//title: 'Company Performance',
			//legend: { position: 'bottom' },
			curveType: 'function',
			hAxis: {
				title: 'Time',
				logScale: false
			},
			/*
			vAxis: {
			  title: 'Popularity',
			  logScale: false
			},
			*/
			explorer: {
				actions: ['dragToZoom', 'rightClickToReset'],
				axis: 'horizontal',
				keepInBounds: true,
				maxZoomIn: 4.0},
			colors: ['#a52714', '#097138']
		};

		var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
		chart.draw(data, options);
	
	}
}

</script>

</body>

</html>
