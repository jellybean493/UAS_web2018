<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <!--  <link rel="stylesheet" href="http://pixel.uji.es/teaching/leaflet/markercluster/dist/MarkerCluster.css" /> -->
  <link rel="stylesheet" href="http://pixel.uji.es/teaching/leaflet/markercluster/dist/MarkerCluster.Default.css" />
  <script src="http://pixel.uji.es/teaching/leaflet/markercluster/dist/leaflet.markercluster-src.js"></script>
  <script src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <!--  Google Chart  library-->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  


  <style>
    body {
      padding: 0;
      margin: 0;
    }

    html,
    body,
    #map {
	position: relative;
      height: 100%;
      padding: 0;
      margin: 0;
    }
	
	#side_popup {
	position: relative;
      height: 100%;
	  width: 400px;
	  z-index: 2;
	  float:right;
    }
	
	#chart_div {
	  position: relative;
      height: 300px;
	  width: 400px;
	  z-index: 2;
	  float:left;
    }
  </style>

</head>

<body>
	<div id="side_popup">
		<div id="CheckboxDIV" >
				<input type="checkbox" class="cb_chart_var" id="cb_temp" name="Temperature" value="1" checked>
					<label for="cb_temp">Temperature</label>
				<input type="checkbox" class="cb_chart_var" id="cb_humid" name="Relative Humidity" value="2" checked>
					<label for="cb_humid">Relative Humidity</label>
		</div>
		<div id="chart_div"></div>
	</div>
	
<div id="map"></div>
<script>
//load google packages for the chart 
google.charts.load('current', {packages: ['corechart', 'line']});

//Global variables
var marker_id;

function create_map_features() {
//Main function that creates the map element, plot markers and add event listeners to the map features 

	//Creates the map variable
	var map = new L.Map('map');
	
	//Load the tiles for the map
	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,' +
		  '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
		  'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(map);
	
	//URL for the geoJson file 
	//IMPORTANT: 'http-server' need to be running and also the CORS extention in Chrome
	var url = 'http://localhost:8080/markers_project.geojson';
	
	//Jquery call to load GeoJSON from an external file 
	$.getJSON(url,function(data){
		//add all the marker in one variable containing all the functionalities for them.
		var markers =   L.geoJson(data,{
		  pointToLayer: function(feature,latlng){
			var marker = L.marker(latlng);
			//marker.bindPopup(feature.properties.id + '<br/>' + feature.properties.geoid);
			return marker;
		  },
		  onEachFeature: function (feature, layer) {
			layer.on('click', function (e) {
				//console.log(feature.properties.id);
				
				//global variable receives the id of the marker clicked by the user
				marker_id = feature.properties.id
				
				//Run the function that request the data based on the marker clicked by the user
				request_fusiontable_data(marker_id);
				
				//ensure that all times a marked is clicked,
				//all the checkbox from the class ".cb_chart_var" initiate as checked
				$(".cb_chart_var").prop("checked", true)
			});//end Event listener 'click' for the marker
		  }//end onEachFeature
		});
		
		//creates a cluster object
		var clusters = L.markerClusterGroup();
		
		//Add the variable that contains all the markers to the cluster object
		clusters.addLayer(markers);
		
		//Add the clusters to the map
		map.addLayer(clusters); 
		
		//Centralize and zoom the map to fit all the markers in the screen, automatically.
		map.fitBounds(markers.getBounds());

	}); // End Jquery call
}//End create_map_features()
create_map_features();

//Jquery function that map changes in the "#CheckboxDIV",
//when a checkbox from the class ".cb_chart_var" is clicked
$( "#CheckboxDIV" ).on( "change", ".cb_chart_var", function() {

	//for each click(change) in the checkbox a new requestion to the fusion table is made.
	request_fusiontable_data(marker_id);
});

function request_fusiontable_data(marker_id){
	//Initiate all the checkbox, of the same class, already clicked.
	
	//Build the url for making a request to the Fusion Table API.
	//It'll create a HTML element: script. 
	//And then adding the url for the request and append it to the body element. position [0]
	//All the time a new request is made, the old script is replaced by the new script.
	
	//Creates the HTML script element
	var script = document.createElement('script');
	
	//Start to build the URL
	var url = ['https://www.googleapis.com/fusiontables/v2/query?'];
	url.push('sql=');
	
	//Build the query
	var query = "SELECT * "
	query = query+" FROM 1xipnRPglhJ3vQ8RvNbxgKBVN7_Mh54V8J6XHxbce "; 
	//Add to the query the WHERE clause to select the data according the marker clicker
	query = query+" WHERE 'geoid' IN ("+ marker_id.toString()+") "; 
	//Put the results  in a structured ordered manner to be plotted in the chart
	query = query+" ORDER BY 'Time(s)' ASC "; 
	
	//Encode the query and push to the array
	var encodedQuery = encodeURIComponent(query);
	url.push(encodedQuery);
	
	//Calls the callback function after receiving the queried data from Fusion Table
	url.push('&callback=process_fusiontable_data'); 
	//add in the URL the Fusion table API key to be able to query information from it
	url.push('&key=AIzaSyCoC9A3WgFneccRufbysInygnWrhCie-T0');
	//Join all the array elements in one single string without spaces 
	//and also add to script source element closing it.
	//It'll look likes: '<'script src="url_created"'>''<'/script'>'
	script.src = url.join('');
	
	//get the body element position[0] and append the script element to it.
	var body = document.getElementsByTagName('body')[0];
	body.appendChild(script);
}

function process_fusiontable_data(data){
	//Process the data got from the fusion table
	//console.log(data);
	var rows = data['rows'];
	
	//Creates an empty array to insert the array of coordinates to be plotted in the chart
	var PointsToPlot = [];
	
	for (var i in rows) {
		//Variable that holds each coordinate to be plotted in the chart
		var coordinates = [];
		
		//Based on the fusion table, extract the row values to the respective variable.
		var Temperature = parseFloat(rows[i][0]);
		var Relat_Humid = parseFloat(rows[i][1]);
		var Time = parseFloat(rows[i][6]);

		//By default the first column will be always the x value.
		//That's why "Time" needs to be inserted first
		coordinates.push(Time);
		coordinates.push(Temperature);
		coordinates.push(Relat_Humid);
		
		//As default in Google LineChart structure:
		//If there're 3 columns, for ex., "time", "temp" and "moisture"
		//PointsToPlot will be an array containing float arrays of size == 3. being respectively to the columns.
		//Consequently, 2 columns, for ex., "time", "temp". 
		//PointsToPlot will be an array containing float arrays of size == 2. ex: [[1,15],[2,13],...]
		PointsToPlot.push(coordinates);

	}
	//call the drawChart Function
	drawChart(PointsToPlot);
}

function drawChart(PointsToPlot) {
	//Create a Google object to plot the data for the chart
	var data = new google.visualization.DataTable();
	
	//Create a empty array to be inserted the fields to be removed based on the checkboxes that are unchecked
	var position_to_remove = [];
	
	//Array containing the hex colors for plotting the lines. 
	//Color for 5 different y-axis variables.
	//If number of y-axis variables to be plotted is greater than 5,
	//more colors needs to be added to the following array.
	var color_palette_hex = ['#DB3340', '#E8B71A', '#1FDA9A', '#28ABE3', '#8C4646'];
	
	//Add the columns names for the chart
	//The first is always the x-axis, in this specific case, it's the "time". And the rest are for the y-axis.
	data.addColumn('number', "Time");
	
	//Variable the total number of y-axis variables 
	var number_of_variables = 0;

	//Access and manages the checkbox class
	$('.cb_chart_var:checkbox').each(function () {
		
		if ($(this).prop("checked")) {
			//Add the further columns (y axis) based on the attribute name of the checkboxes checked.
			data.addColumn('number', $(this).attr("name") );
		}else{
			//Get the value from the checkbox that represents the position on the PointsToPlot array
			position_to_remove.push( parseInt($(this).prop("value")) );
		}
		number_of_variables++;
	});
	
	//Cut the tail of the color_palette_hex array using the splice function
	//It's needed to to match the number of colors in the array to the number of existing y-axis variables.
	//Once no integer is passed as second argument it will cut the tail of the array
	//EXAMPLE:
	//var fruits = ["Banana", "Orange", "Apple", "Mango"];
	//fruits.splice(2);
	//fruits === ["Banana", "Orange"]
	//var fruits = ["Banana", "Orange", "Apple", "Mango"];
	//fruits.splice(1,2);
	//fruits === ["Banana", "Mango"]
	color_palette_hex.splice( number_of_variables );
	
	//Sort Array descending:
	//It's important to be reversed for the splice function remove greater indexes first until the lowest. Otherwise:
	//removing indexes 1 & 3 for array = ["a", "b", "c", "d", "e"]
	//first will remove the index 1 == "b" and then will remove "e" instead of removing "d".
	position_to_remove.reverse();
	if (position_to_remove.length > 0){
		for (var i in PointsToPlot) {
			for (var j in position_to_remove) {
				//For each array inside the PointsToPlot array
				//it'll delete the position correspondent to the value of 
				//the unchecked checkbox of the class: ".cb_chart_var"
				PointsToPlot[i].splice( position_to_remove[j], 1);
			}
		}
		
		//Loop to make the "color" array with the colors only for the checked checkbox of the class '.cb_chart_var'
		//To make it understandable it's important to go through further explanation.
		//PointsToPlot is an array of arrays containing the values of x and y variables: [[time,var1, var2],[time,var1, var2],...]
		//position_to_remove is an array of int containing the value of the unchecked checkbox.
		//The value of this unchecked checkbox is the position of the variable to be deleted:
		//in other words, a value equals to 1 tells that all the var1 of PointsToPlot will be removed. 
		//remember that the position 0 is always the x-axis, that's why there's no checkboxes with this value.
		//EXAMPLE:
		//If the unchecked checkbox value is equals to 2, it means that position_to_remove array will be [2]
		//and the PointsToPlot array will be: [time,var1],[time,var1],...]
		//once the "colors" array contains the colors for the variables and its tail was already cutted
		//once the total of y-axis variables is 2 it's looks now like: ['#DB3340', '#E8B71A']
		//after the following for_loop look what it'll be:
		//*First remember that the position_to_remove array is equal to [2]
		//*Now look the formula of the following for_loop:
		//>>> color_palette_hex.splice( position_to_remove[j]-1, 1 ); 
		//>>> color_palette_hex.splice( position_to_remove[0]-1, 1 ); --> first loop j=0
		//>>> color_palette_hex.splice( 2-1, 1 ); --> position_to_remove[0]=2
		//>>> color_palette_hex.splice( 1, 1 ); --> 2-1=1
		//it's remove just one element of the color_palette_hex array where the position is equal to 1
		//what means that the "colors" array will lost one value where the position is equal to 1
		//only remaining the element where the position is equal to 0
		//In other words, "colors" array is now: ['#DB3340']
		for (var j in position_to_remove) {	
			color_palette_hex.splice( position_to_remove[j]-1, 1 );
		}
	}
	
	//Add the coordinates for plotting the chart.
	//Array of arrays, where the first element of the child array is the x-axis and the rest for the y-axis
	data.addRows(PointsToPlot)

	//Create the option for the LineChart
	//See documentation in: https://developers.google.com/chart/interactive/docs/gallery/linechart
	var options = {
		//Give a title to the chart
		title: 'Data retrieved from Sensebox',
		
		//Control the position of the legend
		legend: { position: 'bottom' },
		
		//It's supposed to add smoothness to the line plot,
		//But it doesn't seems that is changing anything.
		curveType: 'function',
		
		//Properties for the horizontal axis
		hAxis: {
			title: 'Time',
			logScale: false
		},
		
		//Properties for the vertical axis
		//vAxis: {}
		
		//Option that allows users to pan and zoom Google charts. 
		explorer: {
			actions: ['dragToZoom', 'rightClickToReset'],
			//Just zoom the horizontal axis
			axis: 'horizontal',
			//To ensure that users don't pan where there's no data.
			keepInBounds: true},
		
		//Add the colors to the lines
		colors: color_palette_hex
	};
	
	//Create the LineChart object
	var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
	
	//Plot the coordinates on it.
	chart.draw(data, options);
}

</script>

</body>

</html>
